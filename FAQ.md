<!-- نسخهٔ Markdown برای نمایش در GitHub. فقط در چند بخش از HTML برای راست‌چین/جهت‌دهی استفاده شده است. -->

# سوالات متداول – وب‌سرویس‌های پنل پیامک اموت


> راهنمای کوتاه، کاربردی و حرفه‌ای برای توسعه‌دهندگان و مدیران محصول. همه‌چیز فارسی و راست‌به‌چپ 👋

> **توجه به جهت متن**: بیشتر بخش‌ها با Markdown عادی نوشته شده‌اند و مرورگرها معمولاً فارسی را راست‌به‌چپ نمایش می‌دهند. برای چند مورد خاص (مانند تکه‌کدها) از HTML ساده جهت تعیین جهت نمایش استفاده شده است.

---

## فهرست سریع

* [۱) احراز هویت و کلیدها](#۱-احراز-هویت-و-کلیدها)
* [۲) ارسال پیامک](#۲-ارسال-پیامک)
* [۳) گزارش تحویل (DLR) و وضعیت‌ها](#۳-گزارش-تحویل-dlr-و-وضعیت‌ها)
* [۴) دریافت پیام و وب‌هوک](#۴-دریافت-پیام-و-وب‌هوک)
* [۵) شماره/خط اختصاصی](#۵-شمارهخط-اختصاصی)
* [۶) مخاطبین و گروه‌ها](#۶-مخاطبین-و-گروه‌ها)
* [۷) سهمیه‌ها، ریت‌لیمیت و خطاها](#۷-سهمیه‌ها-ریت‌لیمیت-و-خطاها)
* [۸) هزینه و صورت‌حساب](#۸-هزینه-و-صورت‌حساب)
* [۹) امنیت و رعایت قوانین](#۹-امنیت-و-رعایت-قوانین)
* [۱۰) عیب‌یابی سریع](#۱۰-عیب‌یابی-سریع)
* [۱۱) نمونه‌کدهای کوتاه](#۱۱-نمونه‌کدهای-کوتاه)

---

## ۱) احراز هویت و کلیدها

### چطور به API اموت احراز هویت کنم؟

از **Bearer Token** در هدر `Authorization` استفاده کنید:

<div dir="ltr">

```bash
curl -X GET https://api.amoot-sms.example.com/v1/profile \
  -H "Authorization: Bearer <YOUR_API_KEY>"
```

</div>

> ℹ️ **نکته امنیتی:** کلید را فقط در سمت سرور نگهداری کنید. قرار دادن در فرانت‌اند ریسک افشا دارد.

### تفاوت کلیدهای تست و عملیاتی چیست؟

کلید **تست** پیام واقعی ارسال نمی‌کند و برای توسعه/QA است؛ کلید **عملیاتی** برای ترافیک Production است. ممکن است **Rate Limit** متفاوت باشد.

### احراز هویت مبتنی بر IP هم دارید؟

بله؛ می‌توانید IPهای مجاز را در پنل اضافه کنید تا درخواست‌ها فقط از آن‌ها پذیرفته شوند. این قابلیت **مکمل توکن** است و جایگزین آن نیست.

---

## ۲) ارسال پیامک

### ساده‌ترین روش ارسال یک پیامک تکی چیست؟

<div dir="ltr">

```bash
curl -X POST https://api.amoot-sms.example.com/v1/messages \
  -H "Authorization: Bearer <API_KEY>" \
  -H "Content-Type: application/json" \
  -d '{
    "from": "3000XXXX",
    "to":   ["98912XXXXXXX"],
    "text": "کد تایید شما: 123456"
  }'
```

</div>

پاسخ نمونه:

<div dir="ltr">

```json
{
  "message_id": "msg_7x8r12",
  "status": "queued",
  "parts": 1,
  "encoding": "gsm7"
}
```

</div>

### ارسال انبوه/گروهی چطور انجام می‌شود؟

با ارسال آرایهٔ شماره‌ها یا استفاده از شناسهٔ گروه مخاطبین:

<div dir="ltr">

```json
{
  "from": "3000XXXX",
  "to": ["98912...", "98910...", "98935..."],
  "text": "فروش ویژه فقط امروز!"
}
```

</div>

> ✅ **بهینه‌سازی:** برای **بیش از ۵هزار** شماره از آپلود فایل/Job Queue استفاده کنید تا صف‌بندی بهینه شود.

### پیامک‌های طولانی و یونیکد چطور محاسبه می‌شوند؟

پیامک با کاراکترهای فارسی/ایموجی با **UTF‑16** ارسال می‌شود. آستانهٔ قطعه‌ها:

* **GSM‑7:** 160 کاراکتر *(متصل: 153)*
* **Unicode:** 70 کاراکتر *(متصل: 67)*

---

## ۳) گزارش تحویل (DLR) و وضعیت‌ها

### وضعیت‌های ممکن پیام چیست؟

* **queued** – در صف ارسال
* **sent** – به اپراتور ارسال شد
* **delivered** – تحویل به گوشی
* **failed** – شکست خورده
* **expired** – زمان‌سپری
* **rejected** – رد توسط اپراتور/فیلتر

استعلام وضعیت:

<div dir="ltr">

```bash
curl -H "Authorization: Bearer <API_KEY>" \
https://api.amoot-sms.example.com/v1/messages/msg_7x8r12
```

</div>

---

## ۴) دریافت پیام و وب‌هوک

### چطور وب‌هوک دریافت DLR/Inbox تنظیم کنم؟

در پنل مسیر وب‌هوک را ثبت کنید. ساختار نمونهٔ POST:

<div dir="ltr">

```json
{
  "event": "dlr",
  "message_id": "msg_7x8r12",
  "status": "delivered",
  "to": "98912XXXXXXX",
  "timestamp": "2025-10-26T08:15:30Z",
  "signature": "hmac-sha256=..."
}
```

</div>

> 🔐 **امنیت:** هدر امضا (HMAC) را با **کلید وب‌هوک** اعتبارسنجی کنید.

### آیا دریافت پیام پاسخ کاربر (MO) پشتیبانی می‌شود؟

بله؛ رویداد `mo` با فیلدهای `from`، `to`، `text` ارسال می‌شود.

---

## ۵) شماره/خط اختصاصی

### برای استفاده از خط اختصاصی چه مدارکی لازم است؟

* شرکت‌ها: **روزنامه رسمی، شناسه ملی، تعهدنامهٔ محتوایی**
* اشخاص: **کارت ملی و تعهدنامه**

> ⏱️ زمان فعال‌سازی بسته به اپراتور متفاوت است.

### ارسال روی بلک‌لیست (NDNC) ممکن است؟

برای پیام‌های **خدماتی/OTP** با احراز شرایط «سرویس خدماتی» امکان‌پذیر است؛ **تبلیغاتی** روی بلک‌لیست مسدود می‌شود.

---

## ۶) مخاطبین و گروه‌ها

### اضافه‌کردن مخاطب از طریق API چگونه است؟

<div dir="ltr">

```bash
curl -X POST https://api.amoot-sms.example.com/v1/contacts \
  -H "Authorization: Bearer <API_KEY>" -H "Content-Type: application/json" \
  -d '{"name":"علی","phone":"98912XXXXXXX","groups":["vip","tehran"]}'
```

</div>

---

## ۷) سهمیه‌ها، ریت‌لیمیت و خطاها

### محدودیت نرخ درخواست‌ها (Rate Limit) چیست؟

نمونهٔ سربرگ‌ها:

<div dir="ltr">

```
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 42
X-RateLimit-Reset: 173
```

</div>

> ⚠️ اگر **429** دریافت کردید، از صف‌بندی با **Backoff نمایی** استفاده کنید.

### کدهای خطای رایج کدام‌اند؟

|  کد | معنا               | راه‌حل سریع                           |
| --: | ------------------ | ------------------------------------- |
| 400 | ورودی نامعتبر      | اسکیما و الزامات فیلدها را بررسی کنید |
| 401 | توکن نامعتبر/منقضی | توکن را نوسازی یا صحیح ارسال کنید     |
| 403 | دسترسی ندارید      | سطح دسترسی/آی‌پی مجاز را چک کنید      |
| 404 | شیء یافت نشد       | شناسهٔ پیام/منبع را بررسی کنید        |
| 429 | Rate Limit         | Backoff و تجمیع درخواست               |
| 5xx | خطای سرور          | تلاش مجدد مبتنی بر Jitter             |

---

## ۸) هزینه و صورت‌حساب

### هزینه پیام‌ها چگونه محاسبه می‌شود؟

بر اساس **اپراتور، نوع پیام (خدماتی/تبلیغاتی)، تعداد قطعات و مقصد بین‌الملل**. هزینهٔ هر قطعه جداگانه محاسبه می‌شود.

### آیا گزارش مالیات/صورتحساب قابل دریافت از API است؟

بله، از مسیر `/v1/billing/invoices` با فیلتر تاریخ استفاده کنید.

---

## ۹) امنیت و رعایت قوانین

### چگونه از داده‌ها حفاظت کنیم؟

* فعالسازی **محدودیت IP**، **دوران‌کلید (Key Rotation)** و **حداقل دسترسی**
* ذخیره‌سازی امن لاگ‌ها بدون **متن کامل پیام‌های حساس**
* **اعتبارسنجی امضای وب‌هوک** و استفاده از **HTTPS**

### قوانین محتوایی پیامک چیست؟

پیام‌های خلاف قانون/قمار/محتوای نامناسب ممنوع است. پیام تبلیغاتی باید امکان **لغو عضویت** داشته باشد *(مثلاً «لغو11»)*.

---

## ۱۰) عیب‌یابی سریع

### پیام نمی‌رسد؛ از کجا شروع کنم؟

1. اعتبار `from` و فعال‌بودن خط
2. عدم فیلتر تبلیغاتی/بلک‌لیست
3. کاهش متن/یونیکد برای کمترشدن قطعات
4. بررسی **DLR** و لاگ اپراتور

### خطای 401/403 دارم؛ چه کنم؟

* توکن معتبر و بدون فاصله/نقل‌قول اشتباه
* عدم انقضای کلید یا **محدودیت IP**
* فعال‌بودن **Scope**های لازم روی کلید

---

## ۱۱) نمونه‌کدهای کوتاه

### Node.js (fetch)

<div dir="ltr">

```js
await fetch("https://api.amoot-sms.example.com/v1/messages",{
  method:"POST",
  headers:{ "Authorization":"Bearer <API_KEY>","Content-Type":"application/json" },
  body: JSON.stringify({ from:"3000XXXX", to:["98912XXXXXXX"], text:"Hello" })
});
```

</div>

### Python (requests)

<div dir="ltr">

```py
import requests
r = requests.post("https://api.amoot-sms.example.com/v1/messages",
  headers={"Authorization":"Bearer <API_KEY>"},
  json={"from":"3000XXXX","to":["98912XXXXXXX"],"text":"سلام"})
print(r.json())
```

</div>

### وب‌هوک (Express)

<div dir="ltr">

```js
app.post("/webhook/sms", express.json(), (req,res) => {
  const sig = req.header("X-Amoot-Signature");
  // validate(sig, req.body) ...
  console.log(req.body);
  res.sendStatus(200);
});
```

</div>

---

> اگر به موردی برنخوردید، پرسش خود را **به‌همراه شناسهٔ پیام و زمان ارسال** مطرح کنید تا دقیق بررسی شود.
